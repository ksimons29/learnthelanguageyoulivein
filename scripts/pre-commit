#!/bin/bash

# LLYLI Pre-Commit Hook
# Warns if CHANGELOG.md hasn't been updated in a commit with significant changes

# Colors for output
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

# Count significant file changes (excluding common auto-generated/config files)
SIGNIFICANT_CHANGES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|css|md)$' | grep -v 'node_modules' | grep -v 'package-lock.json' | grep -v '.next' | wc -l | tr -d ' ')

# Check if CHANGELOG.md is in the staged files
CHANGELOG_UPDATED=$(echo "$STAGED_FILES" | grep -c 'CHANGELOG.md')

# If there are significant changes but no CHANGELOG update, warn the user
if [ "$SIGNIFICANT_CHANGES" -gt 2 ] && [ "$CHANGELOG_UPDATED" -eq 0 ]; then
    echo ""
    echo -e "${YELLOW}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${YELLOW}║  ⚠️  CHANGELOG.md has not been updated!                     ║${NC}"
    echo -e "${YELLOW}╠════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${YELLOW}║  You have ${SIGNIFICANT_CHANGES} significant file changes but no changelog entry.  ║${NC}"
    echo -e "${YELLOW}║                                                            ║${NC}"
    echo -e "${YELLOW}║  Please update CHANGELOG.md with:                          ║${NC}"
    echo -e "${YELLOW}║  - Session number and date                                 ║${NC}"
    echo -e "${YELLOW}║  - What was done                                           ║${NC}"
    echo -e "${YELLOW}║  - Files created/modified                                  ║${NC}"
    echo -e "${YELLOW}║  - Key technical decisions                                 ║${NC}"
    echo -e "${YELLOW}╠════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${YELLOW}║  To skip this warning (not recommended):                   ║${NC}"
    echo -e "${YELLOW}║  git commit --no-verify                                    ║${NC}"
    echo -e "${YELLOW}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # Prompt user to continue or abort
    exec < /dev/tty
    read -p "Continue without updating CHANGELOG.md? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Commit aborted. Please update CHANGELOG.md first.${NC}"
        exit 1
    fi

    echo "Proceeding with commit (changelog not updated)..."
fi

exit 0
